blueprint:
  name: Voice - Devices Schedules Controller
  author: luuquangvu
  source_url: https://github.com/luuquangvu/tutorials/blob/dev/devices_schedules_controller_full_llm.yaml
  description: |-
    # Devices Schedules Controller used for Voice Assistant

    - Uses the Devices Schedules script to manage per-device timers (start / cancel / cancel_all / extend / pause / resume / list).
    - Accepts friendly names from the LLM, resolves them to entity_ids via the provided alias sensor, and can operate on multiple devices in one request.
    - For `start`, the blueprint dispatches timers via `script.turn_on` with on-completion actions to turn the device on/off. Other modes call the Devices Schedules script directly to receive structured responses.

    ## Blueprint Capabilities

    This controller can schedule various actions for different device types:

    - **Generic On/Off:** `turn_on`, `turn_off` (for switches, lights, fans, media players, generic climate devices).
    - **Covers/Valves:** `open`, `close`, `stop_cover`, `set_position` (with a value 0-100%).
    - **Lights:** `set_brightness` (with a value 0-100%), `set_color` (with a color name).
    - **Fans:** `set_fan_speed` (with a value 0-100%), `set_oscillation` (with true/false).
    - **Climate/Water Heater:** `set_temperature` (with a target temperature), `set_hvac_mode` (with a mode like 'cool', 'heat', 'off', 'auto').
    - **Humidifiers:** `set_humidity` (with a target percentage).
    - **Scenes:** `activate` (to activate a specific scene).
    - **Scripts:** `run_script` (to execute another Home Assistant script).
    - **Media Players:** `media_play`, `media_pause`, `media_stop`, `set_volume` (with a value 0-100%).
    - **Vacuum Robots:** `start_vacuum`, `return_vacuum`.
    - **Buttons:** `press` (to press a button or input_button).
    - **Notifications:** `announce` (to speak a text message via TTS, requires a text value and TTS configuration).

    ## Blueprint Setup

    ### Required

    - The `devices_schedules.yaml` and `devices_schedules_restart_handler.yaml` blueprints needs to be installed.
    - The mentioned file(s) is/are included in the repository.
    - A template sensor stores all information about entity aliases needs to be configured in `config/configuration.yaml`; The sensor is required for friendly-name lookup.

    ```yaml
    # File configuration.yaml

    shell_command:
      get_entity_alias: jq '[.data.entities[] | select(.options.conversation.should_expose == true and (.aliases | length > 0)) | {entity_id, aliases}]' ./.storage/core.entity_registry
    template:
      - triggers:
          - trigger: homeassistant
            event: start
          - trigger: event
            event_type: event_template_reloaded
        actions:
          - action: shell_command.get_entity_alias
            response_variable: response
        sensor:
          - name: "Assist: Entity IDs and Aliases"
            unique_id: entity_ids_and_aliases
            icon: mdi:format-list-bulleted
            device_class: timestamp
            state: "{{ now().isoformat() }}"
            attributes:
              entities: "{{ response.stdout }}"
    ```

    ### Note

    - Make sure to expose the entities you want to control to Assist.
    - Make sure to expose the script to Assist after the script has been saved.
    - Do not alter the default script name.
    - Once the script is created, click the three dots in the top right corner, choose "Edit in YAML," and remove the `description: ...` line to restore the default. This step is important because it helps the LLM better understand the script's purpose.
  domain: script
  homeassistant:
    min_version: 2024.10.0
  input:
    required_settings:
      name: Required settings
      icon: mdi:script-text
      description: Select the dependencies used by this blueprint.
      input:
        timer_script:
          name: Devices Schedules script entity
          description: Script entity created from the Devices Schedules blueprint.
          selector:
            entity:
              filter:
                - domain: script
        entity_aliases:
          name: Entity aliases sensor
          description: Template sensor attribute that lists exposed entities with friendly-name aliases.
          selector:
            entity:
              filter:
                - domain: sensor
                  integration: template
        tts_entity:
          name: TTS Provider Entity
          description: The TTS entity to use (e.g., tts.google_translate_en_com, tts.google_cloud). Required only if you use 'announce' action.
          selector:
            entity:
              filter:
                - domain: tts
          default: ""
    prompt_settings:
      name: Prompt settings for the LLM
      icon: mdi:robot
      description: Optional prompt overrides used by the LLM when collecting arguments.
      collapsed: true
      input:
        mode_prompt:
          name: Mode prompt
          selector:
            text:
              multiline: true
          default: |-
            Mandatory. exactly one: start (queue), cancel (stop latest), cancel_all (stop every), extend (add duration), pause (freeze), resume (restart), list (report). Output bare keyword only.
        entities_prompt:
          name: Entities prompt
          selector:
            text:
              multiline: true
          default: |-
            Entities to control (name/ID/alias). Semicolon-separated. Required for start, cancel, extend, pause, resume. Optional for list, cancel_all. Remove duplicates.
        action_prompt:
          name: Action prompt
          selector:
            text:
              multiline: true
          default: |-
            Required for start. use snake_case: turn_on/off, set_brightness/fan_speed/temperature/humidity/hvac_mode/volume, activate (scene), run_script, open/close, stop_cover, set_position, media_play/pause/stop, start/return_vacuum, press (button), announce (TTS).
        value_prompt:
          name: Value prompt
          selector:
            text:
              multiline: true
          default: |-
            Required for start if action needs value: 0-100 (pct/vol), numeric (temp), hvac_mode (cool/heat/etc), color name, boolean (oscillation), or text (announce). Empty if not needed.
        duration_prompt:
          name: Duration prompt
          selector:
            text:
              multiline: true
          default: |-
            Required for start or extend. Formats: HH:MM:SS, MM:SS, or seconds (e.g., 00:10:00, 600). Empty if not needed.
mode: parallel
max_exceeded: silent
description: Advanced controller for managing multiple device timers. Can start, cancel, pause, resume, or list scheduled actions for various entities.
variables:
  version: 20260222
fields:
  mode:
    name: Mode
    description: !input mode_prompt
    required: true
    selector:
      select:
        options: [start, cancel, cancel_all, extend, pause, resume, list]
  entities:
    name: Entities
    description: !input entities_prompt
    selector:
      text:
  action:
    name: Expire action
    description: !input action_prompt
    selector:
      select:
        options:
          - label: Turn on
            value: turn_on
          - label: Turn off
            value: turn_off
          - label: Activate Scene
            value: activate
          - label: Run Script
            value: run_script
          - label: Open Cover/Valve
            value: open
          - label: Close Cover/Valve
            value: close
          - label: Stop Cover
            value: stop_cover
          - label: Set Cover Position
            value: set_position
          - label: Set Brightness
            value: set_brightness
          - label: Set Color
            value: set_color
          - label: Set Fan Speed
            value: set_fan_speed
          - label: Set Oscillation
            value: set_oscillation
          - label: Set Temperature
            value: set_temperature
          - label: Set Humidity
            value: set_humidity
          - label: Set HVAC Mode
            value: set_hvac_mode
          - label: Media Play
            value: media_play
          - label: Media Pause
            value: media_pause
          - label: Media Stop
            value: media_stop
          - label: Set Volume
            value: set_volume
          - label: Start Vacuum
            value: start_vacuum
          - label: Return Vacuum
            value: return_vacuum
          - label: Press Button
            value: press
          - label: Announce (TTS)
            value: announce
  action_value:
    name: Action Value
    description: !input value_prompt
    selector:
      text:
  duration:
    name: Duration (HH:MM:SS)
    description: !input duration_prompt
    selector:
      text:

sequence:
  - variables:
      _timer_script: !input timer_script
      _entity_aliases: !input entity_aliases
      _tts_entity: !input tts_entity
      _mode: "{{ (mode | default('list', true)) | string | lower | replace('-', '_') | replace(' ', '_') | trim('_') }}"
      _entities_raw: "{{ entities | default('', true) }}"
      _action_raw: "{{ action | default('', true) }}"
      _value_raw: "{{ action_value | default('', true) }}"
      _duration_raw: "{{ duration | default('00:00:00', true) }}"
      _entity_names: >-
        {% set ns = namespace(items=[]) %}
        {% set text = (_entities_raw | string) %}
        {% set normalized = text.replace('\r\n','\n').replace('\r','\n').replace(',', ';').replace('\n',';') %}
        {% for name in normalized.split(';') %}
          {% set trimmed = name | trim %}
          {% if trimmed | length > 0 and (trimmed not in ns.items) %}
            {% set ns.items = ns.items + [trimmed] %}
          {% endif %}
        {% endfor %}
        {{ ns.items }}
      _alias_list: >-
        {% set raw = state_attr(_entity_aliases, 'entities') %}
        {% if raw is string %}
          {% set trimmed = raw | trim %}
          {% set first = trimmed[0:1] %}
          {% if (trimmed | length) > 0 and first in ['[','{'] %}
            {% set parsed = from_json(trimmed) %}
          {% else %}
            {% set parsed = [] %}
          {% endif %}
        {% else %}
          {% set parsed = raw %}
        {% endif %}
        {{ parsed if parsed is sequence else [] }}
      _resolved_details: >-
        {% set ns = namespace(items=[]) %}
        {% for name in _entity_names %}
          {% set name_s = name | string | trim %}
          {% set name_l = name_s | lower %}
          {% set match = namespace(done=false, entity_id='') %}

          {% if not match.done and '.' in name_s and states[name_s] is not none %}
            {% set match.entity_id = name_s %}
            {% set match.done = true %}
          {% endif %}

          {% if not match.done %}
            {% set s_match = states | selectattr('attributes.friendly_name', 'eq', name_s) | list %}
            {% if s_match | length > 0 %}
              {% set match.entity_id = s_match[0].entity_id %}
              {% set match.done = true %}
            {% endif %}
          {% endif %}

          {% if not match.done %}
            {% for device in _alias_list %}
              {% if not match.done %}
                {% set aliases = device.aliases if device.aliases is sequence else [] %}
                {% if name_s in aliases or name_l in (aliases | map('lower') | list) %}
                  {% set match.entity_id = device.entity_id %}
                  {% set match.done = true %}
                {% endif %}
              {% endif %}
            {% endfor %}
          {% endif %}

          {% if match.done %}
            {% set ns.items = ns.items + [dict(name=name, entity_id=match.entity_id)] %}
          {% endif %}
        {% endfor %}
        {{ ns.items }}
      _resolved_entities: >-
        {% set ns = namespace(items=[]) %}
        {% set ignored_domains = ['binary_sensor', 'calendar', 'device_tracker', 'person', 'sensor', 'sun', 'todo', 'weather', 'zone'] %}
        {% for item in _resolved_details %}
          {% set eid = item.entity_id | default('', true) | string %}
          {% set domain = eid.split('.')[0] if '.' in eid else '' %}
          {% if eid | length > 0 and eid not in ns.items and domain not in ignored_domains %}
            {% set ns.items = ns.items + [eid] %}
          {% endif %}
        {% endfor %}
        {{ ns.items }}
      _missing_entities: >-
        {% set resolved_names = _resolved_details | map(attribute='name') | list %}
        {% set ns = namespace(items=[]) %}
        {% for name in _entity_names %}
          {% if name not in resolved_names %}
            {% set ns.items = ns.items + [name] %}
          {% endif %}
        {% endfor %}
        {{ ns.items }}
      _duration_seconds: >-
        {% set raw = _duration_raw %}
        {% if raw is number %}
          {{ raw | round(0) | int(0) }}
        {% elif raw is string and raw | trim | length > 0 %}
          {% set td = as_timedelta(raw) %}
          {% if td is not none and td is not string %}
            {{ td.total_seconds() | round(0) | int(0) }}
          {% else %}
            {% set text = raw | trim %}
            {% set parts = text.split(':') %}
            {% if parts | length >= 3 %}
              {% set hours = (parts[-3] | default('0') | float(0)) %}
              {% set minutes = (parts[-2] | default('0') | float(0)) %}
              {% set seconds = (parts[-1] | default('0') | float(0)) %}
              {{ (hours * 3600 + minutes * 60 + seconds) | round(0) | int(0) }}
            {% elif parts | length == 2 %}
              {% set minutes = (parts[0] | default('0') | float(0)) %}
              {% set seconds = (parts[1] | default('0') | float(0)) %}
              {{ (minutes * 60 + seconds) | round(0) | int(0) }}
            {% else %}
              {{ parts[0] | float(0) | round(0) | int(0) }}
            {% endif %}
          {% endif %}
        {% else %}
          0
        {% endif %}
      _action_normalized: >-
        {{ _action_raw | string | lower | replace(' ', '_') | trim }}
      _action_service_map:
        turn_on: "homeassistant.turn_on"
        turn_off: "homeassistant.turn_off"
        activate: "scene.turn_on"
        run_script: "script.turn_on"
        open: "cover.open_cover"
        close: "cover.close_cover"
        set_brightness: "light.turn_on"
        set_color: "light.turn_on"
        stop_cover: "cover.stop_cover"
        set_position: "cover.set_cover_position"
        set_fan_speed: "fan.set_percentage"
        set_oscillation: "fan.oscillate"
        set_temperature: "climate.set_temperature"
        set_humidity: "humidifier.set_humidity"
        set_hvac_mode: "climate.set_hvac_mode"
        media_play: "media_player.media_play"
        media_pause: "media_player.media_pause"
        media_stop: "media_player.media_stop"
        set_volume: "media_player.volume_set"
        start_vacuum: "vacuum.start"
        return_vacuum: "vacuum.return_to_base"
      _responses: []
      _clean_value: >-
        {% set a = _action_normalized %}
        {% set v = _value_raw %}
        {% if a in ['set_position','set_brightness','set_fan_speed','set_humidity'] %}
          {% set num = (v | float(0)) %}
          {% if num < 0 %}{% set num = 0 %}{% endif %}
          {% if num > 100 %}{% set num = 100 %}{% endif %}
          {{ num | round(0) | int(0) }}
        {% elif a == 'set_volume' %}
          {% set num = (v | float(0)) %}
          {% if num < 0 %}{% set num = 0 %}{% endif %}
          {% if num > 100 %}{% set num = 100 %}{% endif %}
          {{ (num / 100.0) | round(2) }}
        {% elif a == 'set_oscillation' %}
          {% set t = (v | string | lower | trim) %}
          {% if t in ['true','on','yes','1'] %}
            true
          {% elif t in ['false','off','no','0'] %}
            false
          {% else %}
            false
          {% endif %}
        {% elif a == 'set_temperature' %}
          {{ (v | float(0)) | round(1) }}
        {% elif a == 'set_hvac_mode' %}
          {{ (v | string | lower | trim) }}
        {% elif a == 'set_color' %}
          {{ (v | string | trim) }}
        {% elif a == 'announce' %}
          {{ (v | string | trim) }}
        {% else %}
          {{ v }}
        {% endif %}

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ _entity_names | length > 0 and (_missing_entities | length) > 0 }}"
        sequence:
          - variables:
              response: >-
                {{ dict(error='Unknown device name(s): ' ~ (_missing_entities | join(', ')), mode=_mode) }}
          - stop: "Unknown device name(s)"
            response_variable: response

      - conditions:
          - condition: template
            value_template: "{{ _mode in ['start','cancel','extend','pause','resume'] and (_resolved_entities | length) == 0 }}"
        sequence:
          - variables:
              response: >-
                {{ dict(error='No controllable devices were resolved.', mode=_mode) }}
          - stop: "No controllable devices resolved."
            response_variable: response

      - conditions:
          - condition: template
            value_template: "{{ _mode in ['start', 'extend'] and _duration_seconds <= 0 }}"
        sequence:
          - variables:
              response: >-
                {{ dict(error='Duration must be greater than zero.', mode=_mode) }}
          - stop: "Duration must be greater than zero."
            response_variable: response

      - conditions:
          - condition: template
            value_template: >-
              {{ _resolved_entities | select('match', 'lock\.') | list | length > 0 }}
        sequence:
          - variables:
              response: >-
                {{ dict(error='Security Violation: Scheduling actions for locks (smart locks) is strictly prohibited.', mode=_mode) }}
          - stop: "Security restriction: Lock control denied."
            response_variable: response

      - conditions:
          - condition: template
            value_template: "{{ _mode == 'start' and (_action_normalized | string | length) == 0 }}"
        sequence:
          - variables:
              response: >-
                {{ dict(error='Action is required when mode is start.', mode=_mode) }}
          - stop: "Action is required for start mode."
            response_variable: response

      - conditions:
          - condition: template
            value_template: >-
              {% set need_value = _action_normalized in [
                'set_position','set_brightness','set_color','set_fan_speed','set_oscillation',
                'set_temperature','set_humidity','set_hvac_mode','set_volume'] %}
              {{ _mode == 'start' and need_value and (_value_raw | string | trim | length) == 0 }}
        sequence:
          - variables:
              response: >-
                {{ dict(error='A value is required for action: ' ~ _action_normalized, mode=_mode) }}
          - stop: "Value is required for action."
            response_variable: response

      - conditions:
          - condition: template
            value_template: "{{ _mode == 'start' and _action_normalized == 'announce' and (_tts_entity | default('', true) | length) == 0 }}"
        sequence:
          - variables:
              response: >-
                {{ dict(error='Configuration Error: TTS Entity is not configured in the blueprint.', mode=_mode) }}
          - stop: "TTS Entity missing configuration."
            response_variable: response

      - conditions:
          - condition: template
            value_template: >-
              {% set allowed = [
                'turn_on','turn_off','activate','run_script','open','close','stop_cover','set_position',
                'set_brightness','set_color','set_fan_speed','set_oscillation','set_temperature','set_humidity',
                'set_hvac_mode','media_play','media_pause','media_stop','set_volume','start_vacuum','return_vacuum',
                'announce','press'
              ] %}
              {{ _mode == 'start' and (_action_normalized | string | length) > 0 and (_action_normalized not in allowed) }}
        sequence:
          - variables:
              response: >-
                {{ dict(error='Unsupported action: ' ~ _action_normalized, mode=_mode) }}
          - stop: "Unsupported action: {{ _action_normalized }}"
            response_variable: response

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ _mode == 'start' }}"
        sequence:
          - repeat:
              for_each: "{{ _resolved_entities }}"
              sequence:
                - variables:
                    _current_entity: "{{ repeat.item }}"
                    _item_target_service: >-
                      {% set current_entity_id = _current_entity | default('') %}
                      {% set domain = current_entity_id.split('.')[0] %}
                      {% if domain in ['button', 'input_button'] %}
                        {{ domain }}.press
                      {% elif _action_normalized == 'set_temperature' and domain == 'water_heater' %}
                        water_heater.set_temperature
                      {% elif _action_normalized in ['open','close'] %}
                        {% if domain == 'cover' %}
                          {% if _action_normalized == 'open' %}cover.open_cover{% else %}cover.close_cover{% endif %}
                        {% elif domain == 'valve' %}
                          {% if _action_normalized == 'open' %}valve.open_valve{% else %}valve.close_valve{% endif %}
                        {% else %}
                          {{ _action_service_map.get(_action_normalized, '') }}
                        {% endif %}
                      {% elif _action_normalized == 'set_position' and domain == 'valve' %}
                        valve.set_valve_position
                      {% elif _action_normalized == 'announce' %}
                        tts.speak
                      {% else %}
                        {{ _action_service_map.get(_action_normalized, '') }}
                      {% endif %}
                    _item_service_data: >-
                      {% set d = dict() %}
                      {% if _action_normalized == 'set_position' %}
                        {% set d = dict(position=_clean_value) %}
                      {% elif _action_normalized == 'set_brightness' %}
                        {% set d = dict(brightness_pct=_clean_value) %}
                      {% elif _action_normalized == 'set_color' %}
                        {% set d = dict(color_name=_clean_value) %}
                      {% elif _action_normalized == 'set_fan_speed' %}
                        {% set d = dict(percentage=_clean_value) %}
                      {% elif _action_normalized == 'set_oscillation' %}
                        {% set d = dict(oscillating=_clean_value) %}
                      {% elif _action_normalized == 'set_temperature' %}
                        {% set d = dict(temperature=_clean_value) %}
                      {% elif _action_normalized == 'set_humidity' %}
                        {% set d = dict(humidity=_clean_value) %}
                      {% elif _action_normalized == 'set_hvac_mode' %}
                        {% set d = dict(hvac_mode=_clean_value) %}
                      {% elif _action_normalized == 'set_volume' %}
                        {% set d = dict(volume_level=_clean_value) %}
                      {% elif _action_normalized == 'announce' %}
                        {% set d = dict(media_player_entity_id=_current_entity, message=_clean_value) %}
                      {% endif %}
                      {{ d }}
                    _item_target_dict: >-
                      {% if _action_normalized == 'announce' %}
                        {{ {'entity_id': _tts_entity} }}
                      {% else %}
                        {{ {'entity_id': _current_entity} }}
                      {% endif %}
                - service: script.turn_on
                  target:
                    entity_id: "{{ _timer_script }}"
                  data:
                    variables:
                      mode: start
                      target_entity: "{{ _current_entity }}"
                      duration_seconds: "{{ _duration_seconds }}"
                      expire_actions:
                        - action: "{{ _item_target_service }}"
                          target: "{{ _item_target_dict }}"
                          data: "{{ _item_service_data }}"
                - variables:
                    _responses: "{{ (_responses | default([])) + [dict(mode='start', entity=_current_entity, status='queued', duration_seconds=_duration_seconds, action=_action_normalized, value=_clean_value)] }}"
          - variables:
              response: >-
                {{ dict(mode='start', action=_action_normalized, duration_seconds=_duration_seconds, targets=_resolved_entities, dispatched=_responses) }}

      - conditions:
          - condition: template
            value_template: "{{ _mode == 'cancel_all' }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ _resolved_entities | length > 0 }}"
                sequence:
                  - repeat:
                      for_each: "{{ _resolved_entities }}"
                      sequence:
                        - service: "{{ _timer_script }}"
                          data:
                            mode: cancel_all
                            target_entity: "{{ repeat.item }}"
                          response_variable: _call_result
                        - variables:
                            _responses: "{{ (_responses | default([])) + [_call_result] }}"
            default:
              - service: "{{ _timer_script }}"
                data:
                  mode: cancel_all
                response_variable: _call_result
              - variables:
                  _responses: "{{ [_call_result] }}"
          - variables:
              response: >-
                {{ dict(mode='cancel_all', targets=_resolved_entities, results=_responses) }}

      - conditions:
          - condition: template
            value_template: "{{ _mode == 'extend' }}"
        sequence:
          - repeat:
              for_each: "{{ _resolved_entities }}"
              sequence:
                - service: "{{ _timer_script }}"
                  data:
                    mode: extend
                    target_entity: "{{ repeat.item }}"
                    extend_seconds: "{{ _duration_seconds }}"
                  response_variable: _call_result
                - variables:
                    _responses: "{{ (_responses | default([])) + [_call_result] }}"
          - variables:
              response: >-
                {{ dict(mode='extend', extend_seconds=_duration_seconds, results=_responses) }}

      - conditions:
          - condition: template
            value_template: "{{ _mode in ['cancel', 'pause', 'resume'] }}"
        sequence:
          - repeat:
              for_each: "{{ _resolved_entities }}"
              sequence:
                - service: "{{ _timer_script }}"
                  data:
                    mode: "{{ _mode }}"
                    target_entity: "{{ repeat.item }}"
                  response_variable: _call_result
                - variables:
                    _responses: "{{ (_responses | default([])) + [_call_result] }}"
          - variables:
              response: >-
                {{ dict(mode=_mode, results=_responses) }}

      - conditions:
          - condition: template
            value_template: "{{ _mode == 'list' }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ _resolved_entities | length > 0 }}"
                sequence:
                  - repeat:
                      for_each: "{{ _resolved_entities }}"
                      sequence:
                        - service: "{{ _timer_script }}"
                          data:
                            mode: list
                            list_entity_filter: "{{ repeat.item }}"
                          response_variable: _call_result
                        - variables:
                            _responses: "{{ (_responses | default([])) + [_call_result] }}"
            default:
              - service: "{{ _timer_script }}"
                data:
                  mode: list
                response_variable: _call_result
              - variables:
                  _responses: "{{ [_call_result] }}"
          - variables:
              _list_results_with_names: >-
                {% set responses = _responses | default([]) %}
                {% set outer = namespace(items=[]) %}
                {% for item in responses %}
                  {% if item is mapping %}
                    {% set timers = item.timers if item.timers is sequence else [] %}
                    {% set timer_ns = namespace(items=[]) %}
                    {% for timer in timers %}
                      {% set entity_id = timer.entity_id | default('') | string %}
                      {% set friendly = state_attr(entity_id, 'friendly_name') %}
                      {% if friendly is none or (friendly | string | trim) == '' or (friendly | string | lower) in ['unknown', 'unavailable'] %}
                        {% set alias_list = _alias_list if _alias_list is sequence else [] %}
                        {% set alias_match = alias_list | selectattr('entity_id', 'eq', entity_id) | map(attribute='aliases') | list %}
                        {% if alias_match | length > 0 %}
                          {% set aliases = alias_match[0] if alias_match[0] is sequence else [] %}
                          {% if aliases | length > 0 %}
                            {% set friendly = aliases[0] %}
                          {% endif %}
                        {% endif %}
                      {% endif %}
                      {% if friendly is none or (friendly | string | trim) == '' %}
                        {% set entity_part = (entity_id.split('.')[-1] if '.' in entity_id else entity_id) %}
                        {% set friendly = (entity_part | replace('_', ' ') | title) %}
                      {% endif %}
                      {% set timer_ns.items = timer_ns.items + [dict(timer, friendly_name=friendly)] %}
                    {% endfor %}
                    {% set outer.items = outer.items + [dict(item, timers=timer_ns.items)] %}
                  {% else %}
                    {% set outer.items = outer.items + [item] %}
                  {% endif %}
                {% endfor %}
                {{ outer.items }}
              response: >-
                {{ dict(mode='list', targets=_resolved_entities, results=_list_results_with_names) }}

    default:
      - variables:
          response: >-
            {{ dict(error='Unsupported mode requested: ' ~ _mode, mode=_mode) }}
      - stop: "Unsupported mode requested: {{ _mode }}"
        response_variable: response

  - stop: ""
    response_variable: response
