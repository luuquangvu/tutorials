blueprint:
  name: Voice - Check Traffic Fine
  author: luuquangvu
  source_url: https://github.com/luuquangvu/tutorials/blob/main/traffic_fine_lookup_full_llm.yaml
  description: |-
    # Tool for checking traffic fines used for Voice Assistant

    ## Blueprint Setup

    ### Required

    - The Pyscript integration needs to be installed through HACS and properly configured.
    - The `scripts/traffic_fine_lookup_tool.py` script needs to be copied into the `config/pyscript` folder.
    - The `scripts/requirements.txt` file needs to be copied into the `config/pyscript` folder.
    - The mentioned file(s) is/are included in the repository.
    - You need to enable two Pyscript options through the UI or via YAML to allow importing all Python packages and to make hass available as a global variable.

    ```
    # File configuration.yaml
    pyscript:
      allow_all_imports: true
      hass_is_global: true
    ```

    ### Optional

    - Adjust the prompts for each field used in the script. The descriptions guide the LLM to provide the correct input.

    ### Note

    - Provide a concise and precise description for the script. This description will enable the LLM to recognize that the script is designed to directly lookup traffic fines from Cổng thông tin điện tử Cục Cảnh sát giao thông (https://www.csgt.vn/).
    - Make sure to expose the script to Assist after the script has been saved.
    - Do not alter the default script name.
    - Once the script is created, click the three dots in the top right corner, choose "Edit in YAML," and remove the `description: ...` line to restore the default. This step is important because it helps the LLM better understand the script's purpose.
  domain: script
  homeassistant:
    min_version: 2024.10.0
  input:
    prompt_settings:
      name: Prompt settings for the LLM
      icon: mdi:robot
      description: You can use these settings to finetune the prompts for your specific LLM (model). In most cases the defaults should be fine.
      collapsed: true
      input:
        license_plate_prompt:
          name: License Plate Prompt
          description: The prompt which will be used for the LLM can provide the license plate number of vehicle for the query.
          selector:
            text:
              multiline: true
          default: |-
            Mandatory. Alphanumeric, no spaces. Silence-correct mispronunciations. Correct to most likely intended plate.
        vehicle_type_prompt:
          name: Vehicle Type Prompt
          description: The prompt which will be used for the LLM can provide the type of vehicle for the query.
          selector:
            text:
              multiline: true
          default: |-
            Mandatory. exact value: 'car', 'motorbike', or 'electricbike'. Do not guess.
mode: parallel
max_exceeded: silent
description: Queries traffic violation databases using a license plate and vehicle type to retrieve fine details accurately.
variables:
  version: 20260223
fields:
  license_plate:
    name: License Plate
    description: !input license_plate_prompt
    selector:
      text:
    required: true
  vehicle_type:
    name: Vehicle Type
    description: !input vehicle_type_prompt
    selector:
      select:
        options:
          - label: Car
            value: car
          - label: Motorbike
            value: motorbike
          - label: Electric Bike
            value: electricbike
    required: true
    default: car
sequence:
  - variables:
      license_plate: "{{ license_plate | default('') | trim }}"
      vehicle_type: "{{ vehicle_type | default('') | trim }}"
  - alias: Check if variables were set correctly
    if:
      - condition: template
        value_template: "{{ not (license_plate and vehicle_type) }}"
    then:
      - alias: Set variable for error message
        variables:
          response:
            error: Unable to check traffic fines because either the license plate number or the vehicle type is empty.
      - alias: Stop the script
        stop: Unable to check traffic fines because either the license plate number or the vehicle type is empty.
        response_variable: response
  - action: pyscript.traffic_fine_lookup_tool
    response_variable: response
    data:
      license_plate: "{{ license_plate }}"
      vehicle_type: "{{ vehicle_type }}"
  - stop: ""
    response_variable: response
